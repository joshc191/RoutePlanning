<!DOCTYPE HTML>
<html>
<head>

  <link href='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css' rel='stylesheet' />
  <script src='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js'></script>
  <script src='https://api.mapbox.com/mapbox.js/plugins/turf/v3.0.11/turf.min.js'></script>

<script src="https://api.tiles.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js"></script>
<link
href="https://api.tiles.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css"
rel="stylesheet"
/>

  <!--Bootstrap-->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">

  <!--CSS sheet-->
  <link rel="stylesheet" href="styles.css">

  <title>ENGO 551 Final Project</title>

</head>

<body>
	<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.2.1/mapbox-gl-draw.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.2.1/mapbox-gl-draw.css" type="text/css">

  <!--navigation bar-->
  <nav class="navbar navbar-expand-lg navbar-light" style="background-color: #e3f2fd;">
    <a class="navbar-brand" href="index.html">
      <img src="delivery.png" height="60" width="60" alt="">
      Route Planning for Mobile Grocery Store
    </a>
  </nav>

  <div class="row">
    <div class="col-md-3">
      <br/>
      <h3>Efficient Route Planning from Uploaded Addresses</h3>
      <p>Please upload a csv file of list of addresses to accomodate on the trip</p>
      <P>The page can be toggled for the list of addresses and the location of the stops and its route</P>
      <br/>
      <div>
      <label for="addresslist">Upload your address list:</label>
      <input type="file"
         id="addresses" name="addresslist"
         accept=".csv">
      </div>
    </div>

    <div class="col-md-9">
      <div id="map"></div>
    </div>

  </div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiY2hyaXNrY2NobyIsImEiOiJja200ZGE3YzEwM2hhMm9wbThweHVpbmdnIn0.WK32LPKYrtmevgs6emkIrQ';
    var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v10',
    center: [-114.0719,51.0447],
    zoom: 12
    });

    //--------------------- READ CSV FILE ----------------------------//
    var addresslist = document.getElementById("addresses");

    // Function which reads file as text when called.
    readFile = function () {
        var reader = new FileReader();
        reader.onload = function () {
            let addressliststr = reader.result;
            var addresslist = addressliststr.split("\n");
            console.log(addresslist);

            // Add stuff here for coordinate querying, clustering, etc.
			funcName(addresslist);

			function getlink (address) { //gets the address url from the API
			let link = "https://data.calgary.ca/resource/9zvu-p8uz.geojson?$q=";
			link+= "'";
			link+= address;
			link+="'";
			return link;
			};

			async function funcName(url){
				var AdjFeatCollec = {type: 'FeatureCollection',features: []};
				var bigdata = {type: 'FeatureCollection',features: []};

				for (i = 0; i < url.length;i++)//Adding individual geojson urls to  a single feat collection
				{
					url4edit = getlink(url[i]);
					//console.log(url4edit);
					
					const response = await fetch(url4edit);
					var data1 = await response.json();
					bigdata.features.push(data1.features[0]);
					//console.log(data1.features[0].properties.address);//check to see if we can access the addresses
				}
				//console.log(bigdata);//based on original CSV
				//console.log(bigdata.features.length);//Check to see if size matches original
				
				var mycount =0;
				for (i = 0; i < bigdata.features.length;i++)//Adjusted feat collection to work with turf 
					{
						mycount= mycount+1;		
						
						var feat = {'type': 'Feature',
							'properties': {
							'Name': bigdata.features[i].properties.street_name,
							'Address': bigdata.features[i].properties.address
							},
							'geometry': {
							'type': 'Point',
							'coordinates': [parseFloat(bigdata.features[i].properties.longitude),
							parseFloat(bigdata.features[i].properties.latitude)]
							}
							};
						AdjFeatCollec.features.push(feat);
						
					};
				
				console.log(AdjFeatCollec);//console log of the final of the loaded csv
		
				//__________________________________________________________________________________
				// Loading maps with points
				map.on('load', function () {
				// Add an image to use as a custom marker
				map.loadImage(
				'https://docs.mapbox.com/mapbox-gl-js/assets/custom_marker.png',
				function (error, image) {
				if (error) throw error;
				map.addImage('custom-marker', image);
				// Add a GeoJSON source with 2 points
				map.addSource('points', {
				'type': 'geojson',
				'data': AdjFeatCollec
				});
				 
				// Add a symbol layer
				map.addLayer({
				'id': 'points',
				'type': 'symbol',
				'source': 'points',
				'layout': {
				'icon-image': 'custom-marker',
				'icon-size': 0.35,
				// get the title name from the source's "title" property
				'text-field': ['get', 'title'],
				'text-font': [
				'Open Sans Semibold',
				'Arial Unicode MS Bold'
				],
				'text-offset': [0, 1.25],
				'text-anchor': 'top'
				}
				});
				}
				);
				});
				
				//__________________________________________________________________________________
				// K-means Clustering 
				//var points = turf.randomPoint(100, {bbox: [ -114.304388, 50.853, -113.865450,51.215771]}); //test data
				//console.log(points);//console log of the clustered points
				
				var points = AdjFeatCollec;
				var options = {numberOfClusters: 3};//amount of clusters, replace with user input
				var clustered = turf.clustersKmeans(points, options);
				
				var total = 0 //countering the number of clusters, remove once user input added 
				turf.clusterEach(clustered, 'cluster', function () {
					total++;
				});
				console.log(total);//console log of the total amount of clusters
				
				var values = {type: 'FeatureCollection',features: []};
				for (i = 0; i < total;i++)//Adding individual geojson urls to  a single feat collection
				{
					var cluster = turf.getCluster(clustered, {cluster: i});
					
					//var clustercoord = cluster.features[0].properties.centroid;
					
					var feat = {'type': 'Feature',
							'properties': {
							'Name': cluster.features[0].properties.cluster //which cluster
							},
							'geometry': {
							'type': 'Point',
							'coordinates': cluster.features[0].properties.centroid //cluster coordinates
							}
							};
						values.features.push(feat);
				}
				console.log(values);//console log of the clustered points
				
				
				//__________________________________________________________________________________
				// Loading maps with  cluster points
				map.on('load', function () {
				// Add an image to use as a custom marker
				map.loadImage(
				'https://cdn0.iconfinder.com/data/icons/small-n-flat/24/678111-map-marker-512.png',
				function (error, image) {
				if (error) throw error;
				map.addImage('custom-mark', image);
				// Add a GeoJSON source with 2 points
				map.addSource('point', {
				'type': 'geojson',
				'data': values
				});
				 
				// Add a symbol layer
				map.addLayer({
				'id': 'point',
				'type': 'symbol',
				'source': 'point',
				'layout': {
				'icon-image': 'custom-mark',
				'icon-size': 0.05,
				// get the title name from the source's "title" property
				'text-field': ['get', 'title'],
				'text-font': [
				'Open Sans Semibold',
				'Arial Unicode MS Bold'
				],
				'text-offset': [0, 1.25],
				'text-anchor': 'top'
				}
				});
				}
				);
				});
				
			};

        };
        // start reading the file. When it is done, calls the onload event defined above.
        reader.readAsText(addresslist.files[0]);
    };

    // Read file by calling readFile
    addresslist.addEventListener('change', readFile);
    //------------------- READ CSV FILE END --------------------------//
	
	
	
	
	
  </script>

  </body>
  </html>
